function findWithAttr(e,t,n){for(var a=0;a<e.length;a+=1)if(e[a][t]===n)return a;return-1}function isEmpty(e){if(null==e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0}var app=angular.module("app",["ngSanitize","ngAnimate","ui.router","angularSpinner","ui.calendar","mgcrea.ngStrap","mentio","datePicker","monospaced.elastic","infinite-scroll","checklist-model","pasvaz.bindonce","angularFileUpload","pascalprecht.translate","angular-growl","ngTagsInput","treeControl"]);app.config(["growlProvider","$httpProvider",function(e,t){e.globalTimeToLive(3e3),t.defaults.headers.common.Token=token;var n=["$rootScope","$q",function(e,t){function n(e){return e}function a(e){var n=e.status;return 401==n?(location.hash="",void console.log("401",e)):t.reject(e)}return function(e){return e.then(n,a)}}];t.responseInterceptors.push(n)}]),angular.module("infinite-scroll").value("THROTTLE_MILLISECONDS",250),app.config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/home"),angular.forEach(modules,function(t){e.state("space."+t.moduleName,{url:"/"+t.moduleName,templateUrl:"modules/"+t.moduleName+"/index.html",controller:t.moduleName+"Ctrl"})}),e.state("home",{url:"/home",templateUrl:"pages/home.html",controller:"homeCtrl"}).state("space",{url:"/space/:spaceCode","abstract":!0,templateUrl:"pages/space.html",controller:"spaceCtrl"}).state("space.stream",{url:"",templateUrl:"pages/space-stream.html",controller:"spaceStreamCtrl"}).state("space.files",{url:"/files",templateUrl:"pages/space-files.html",controller:"spaceFilesCtrl"}).state("space.wiki",{url:"/wiki",templateUrl:"pages/space-wiki.html",controller:"spaceWikiCtrl"}).state("space.tasks",{url:"/tasks",templateUrl:"pages/space-tasks.html",controller:"tasksCtrl"}).state("space.admin",{url:"/admin",templateUrl:"pages/space-admin.html",controller:"spaceAdminCtrl"}).state("search",{url:"/search/{query}",templateUrl:"pages/search.html",controller:"searchCtrl"}).state("post",{url:"/post/{contentId}",templateUrl:"pages/post.html",controller:"postCtrl"}).state("people.test",{url:"/test",templateUrl:"",controller:"peopleCtrl"}).state("messages",{url:"/messages",templateUrl:"pages/messages.html",controller:"messagesCtrl"}).state("admin",{url:"/admin",templateUrl:"pages/admin.html",controller:"adminCtrl"}).state("profile",{url:"/profile",templateUrl:"pages/profile.html",controller:"profileCtrl"}).state("userprofile",{url:"/userprofile/:userid",templateUrl:"pages/userprofile.html",controller:"userprofileCtrl"}),h_tasks||e.state("tasks",{url:"/tasks",templateUrl:"pages/tasks.html",controller:"tasksCtrl"}).state("task",{url:"/task/:taskId",templateUrl:"pages/single-task.html",controller:"singleTaskCtrl"}),h_cal||e.state("calendar",{url:"/calendar",templateUrl:"pages/calendar.html",controller:"calendarCtrl"}),h_people||e.state("people",{url:"/people",templateUrl:"pages/people.html",controller:"peopleCtrl"})}]),app.service("$previousState",["$rootScope","$state",function(e,t){var n=null,a={},i=null;e.$on("$stateChangeStart",function(e,t,a,o,r){i=n,n={state:o,params:r}}),e.$on("$stateChangeError",function(){n=i,i=null}),e.$on("$stateChangeSuccess",function(){i=null});var o={get:function(e){return e?a[e]:n},go:function(e){var n=o.get(e);return console.log(n),console.log(t),""==n.state.name?t.go("home"):n.state.name!=t.current.name?t.go(n.state,n.params):t.go("home")},memo:function(e){a[e]=n}};return o}]),app.run(["$previousState",function(){"use strict"}]),app.filter("htmlToPlaintext",function(){return function(e){return String(e).replace(/<[^>]+>/gm,"")}}),app.filter("groupBy",["$parse",function(e){return function(t,n){var a=[],i=null,o=!1,r="group_by_CHANGED";return angular.forEach(t,function(t){if(o=!1,null!==i){n=angular.isArray(n)?n:[n];for(var s=0,l=n.length;l>s;s++)e(n[s])(i)!==e(n[s])(t)&&(o=!0)}else o=!0;t[r]=o?!0:!1,a.push(t),i=t}),a}}]),app.directive("ngEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(n.ngEnter)}),t.preventDefault())})}}),app.config(["$translateProvider",function(e){e.translations("u",translations),e.preferredLanguage("u")}]),app.directive("lkrChartEditor",function(){return{scope:{chartData:"=data"},restrict:"EA",templateUrl:"directives/chart-editor.html",replace:!0,link:function(e){e.delSerieClick=function(){if(e.chartData.labels.length>1){e.chartData.labels.pop();for(var t="s"+e.chartData.skeys.pop(),n=0;n<e.chartData.data.length;n++)delete e.chartData.data[n][t]}},e.delRowClick=function(t){e.chartData.data.splice(t,1)},e.addRowClick=function(){for(var t={xlabel:translations.LABEL},n=0;n<e.chartData.skeys.length;n++)t["s"+e.chartData.skeys[n]]=0;e.chartData.data.push(t)},e.addSerieClick=function(){e.chartData.labels.push(translations.SERIE);var t=Math.max.apply(Math,e.chartData.skeys)+1;e.chartData.skeys.push(t);for(var n="s"+t,a=0;a<e.chartData.data.length;a++)e.chartData.data[a][n]=0}}}}),app.directive("lkrChartViewer",function(){return{restrict:"EA",templateUrl:"directives/chart-viewer.html",replace:!0,scope:{data:"=data",zoom:"@"}}}),app.directive("lkrColumn",function(){return{restrict:"EA",replace:!0,template:'<strong><a href="javascript:void(0)" ng-click="setOrder()">{{fieldCaption}} </a><i class="fa fa-chevron-down" style="color:#318BBD;" ng-show="sortOptions.column == fieldName && sortOptions.asc"></i><i class="fa fa-chevron-up" style="color:#318BBD;" ng-show="sortOptions.column == fieldName && !sortOptions.asc"></i></strong>',scope:{fieldCaption:"@",fieldName:"@",sortFunction:"&",sortOptions:"="},controller:["$scope","$element","$attrs",function(e){e.setOrder=function(){e.sortFunction({colName:e.fieldName})}}]}}),app.directive("lkrComments",["apiService","formatterService",function(e,t){return{restrict:"EA",templateUrl:"directives/comments.html",replace:!0,scope:{comments:"=comments",className:"@",contentId:"=contentId",commentCount:"=commentCount"},link:function(n){n.body="",n.showPost=!1,n.formatter=t,n.newFiles=[],n.showCommentEditor=!1,n.confirmDeleteClick=function(t){e.delete(["comment",t]).then(function(){var e=findWithAttr(n.comments,"id",t);n.comments.splice(e,1),n.commentCount--})},n.commentFocus=function(){n.showPost=!0},n.peopleClick=function(e){n.$emit("peopleDialogEvent",e)},n.commentPostClick=function(){var t={body:n.body,files:n.newFiles};e.post(["comment",n.className,n.contentId],t).then(function(e){n.commentCount++,n.newFiles.length>0&&n.$emit("commentNewFiles"),n.comments.push(e),n.body="",n.newFiles=[],n.showPost=!1})},n.getAvatar=function(e){return assetsUrl+"/avatar/"+e+".jpg"},n.loadAllComments=function(){e.get(["comment",n.className,n.contentId]).then(function(e){n.comments=e,n.commentCount=e.length})}}}}]),app.directive("lkrConfirmPopup",["$compile","$parse",function(e){return{restrict:"AE",replace:!1,terminal:!0,priority:1e3,scope:{lkrConfirmPopup:"@",lkrConfirmCb:"&",cbValue:"@lkrConfirmCbValue"},link:function(t,n){t.retValue=t.cbValue,t.okClick=function(){var e=t.$eval(t.retValue);t.lkrConfirmCb(e)},t.options=t.$eval(t.lkrConfirmPopup),n.attr("popup-show","directives/pop-confirmation.html"),n.attr("tooltip-placement","bottom"),n.removeAttr("lkr-confirm-popup"),e(n)(t)}}}]),app.directive("lkrContent",["contentService","spaceFactory","starService","$sce","$state","apiService","$popover","formatterService","growl",function(e,t,n,a,i,o,r,s,l){return{restrict:"EA",templateUrl:"directives/content.html",scope:{content:"=content",hasTasks:"="},link:function(r,c,d){r.newTaskView=!1,r.spaceFactory=t,r.sharePostClick=function(e){console.log("share in",e),""!=e&&o.post(["content",r.content.id,"share",e]).then(function(){l.success(translations.POST_SHARED_SUCCESS)})},r.icons=["fa fa-comment","fa fa-link","fa fa-table","fa fa-chart","fa fa-check-square","fa fa-calendar","fa fa-map-marker"],r.zoom=angular.isDefined(d.zoom),r.currentView="comments",r.formatter=s,angular.isDefined(r.content)&&(r.content.content_text=a.trustAsHtml(r.content.content_text)),r.$on("taskCancelEvent",function(){r.newTaskView=!1}),r.translateClick=function(e){console.log("translate"),o.get(["translate","Content",e.id]).then(function(t){e.translated=t.translated,console.log("d",t)})},r.$on("taskInsertEvent",function(e,t){r.content.task_summary.push(t),r.newTaskView=!1,o.get("task/counters",{contentId:r.content.id}).then(function(e){r.content.task_count=e})}),r.viewMoreClick=function(){e.viewMore(r.content.id).then(function(e){r.content.truncated=!1,r.content.content_text=e})},r.newTaskClick=function(){r.newTaskView=!r.newTaskView,r.newTask={user_id:user.id,priority:1,state:0,files:[],error:[]}},r.zoomClick=function(e){"post"!=r.viewMode&&i.go("post",{contentId:e})},r.starredClick=function(e){n.toggle("Content",e).then(function(e){r.content.starred=e})},r.peopleClick=function(){r.$emit("peopleDialogEvent",r.content.user_id)},r.contentMine=function(e){return e==user.id},r.confirmDeleteClick=function(t){e.delete(t).then(function(){r.$emit("contentDeletedEvent",t)})},r.getAvatar=function(e){return assetsUrl+"/avatar/"+e+".jpg"}}}}]),app.directive("lkrEventEditor",["$locale",function(e){return{restrict:"EA",templateUrl:"directives/event-editor.html",scope:{data:"=data",errors:"=errors"},link:function(t){t.dateTimeFormat=e.DATETIME_FORMATS.shortDate+" H:mm",t.dateFormat=e.DATETIME_FORMATS.shortDate,t.eventTypes=[translations.CONFERENCE,translations.CONVENTION,translations.EXAM,translations.EXPO,translations.GAME,translations.MEETING,translations.MILESTONE,translations.PARTY,translations.SEMINAR],t.$watch("data.end_date",function(){t.errors={}}),t.$watch("data.start_date",function(){if(t.errors={},t.data.start_date&&(!t.data.end_date||t.data.end_date<t.data.start_date)){var e=new Date;e=t.data.start_date,e.setHours(e.getHours()+1),t.data.end_date=e}})}}}]),app.directive("lkrEventViewer",["formatterService","apiService","$locale",function(e,t,n){return{restrict:"EA",templateUrl:"directives/event-viewer.html",replace:!0,scope:{data:"=data",calendar:"=calendar",author:"=author",contentid:"=contentid"},link:function(a){a.month=moment(a.data.start_date).format("MMM"),a.day=moment(a.data.start_date).format("D"),a.myAtt=null,a.dateTimeFormat=n.DATETIME_FORMATS.shortDate+" H:mm",a.dateFormat=n.DATETIME_FORMATS.shortDate,a.new={start_date:null,end_date:null,all_day:!1},a.formatter=e,a.changeOkClick=function(){return a.errors={},moment(a.new.start_date).isValid()?moment(a.new.end_date).isValid()?(a.new.all_day&&(a.new.start_date.setHours(12,0,0),a.new.end_date.setHours(12,0,0)),a.new.end_date<a.new.start_date?void(a.errors["event.end_date"]="Invalid date"):void t.put(["event",a.contentid],a.new).then(function(){a.data.start_date=a.new.start_date,a.data.end_date=a.new.end_date,a.data.all_day=a.new.all_day,a.editing=!1,a.month=moment(a.data.start_date).format("MMM"),a.day=moment(a.data.start_date).format("D"),a.att={0:{total:0,users:""},1:{total:0,users:""},2:{total:0,users:""}},a.myAtt=null,1==a.data.all_day?(a.fullDate=moment(a.data.start_date).format("dddd, LL"),a.endDate=moment(a.data.end_date).format("dddd, LL")):(a.fullDate=e.longDate(a.data.start_date),a.endDate=e.longDate(a.data.end_date))})):void(a.errors["event.end_date"]="Invalid date"):void(a.errors["event.start_date"]="Invalid date")},a.editClick=function(){a.editing=!0},a.init=function(){a.att={0:{total:0,users:""},1:{total:0,users:""},2:{total:0,users:""}},null!=a.calendar&&angular.isDefined(a.calendar.attendants)&&angular.forEach(a.calendar.attendants,function(e){a.att[e.attending].total=a.att[e.attending].total+1,""!=a.att[e.attending].users&&(a.att[e.attending].users=a.att[e.attending].users+"<br>"),a.att[e.attending].users=a.att[e.attending].users+e.user.full_name,e.user.id==user.id&&(a.myAtt=e.attending)})},1==a.data.all_day?(a.fullDate=moment(a.data.start_date).format("dddd, LL"),a.endDate=moment(a.data.end_date).format("dddd, LL")):(a.fullDate=e.longDate(a.data.start_date),a.endDate=e.longDate(a.data.end_date)),a.assistClick=function(e){t.get(["assist",a.calendar.calendarable_id,parseInt(e)]).then(function(e){a.calendar.attendants=e.attendants,a.init()})},a.init()}}}]),app.directive("lkrFieldRadio",function(){return{restrict:"EA",templateUrl:"directives/field-radio.html",replace:!0,scope:{originalValue:"=value",fieldName:"@value",radioValues:"=",updateCb:"&",label:"@",allowEdit:"@"},link:function(e){e.editing=!1,e.radioClick=function(t){var n=e.fieldName;n.indexOf(".")>=0&&(n=n.split(".")[n.split(".").length-1]),e.updateCb({fieldName:n,fieldValue:t}).then(function(){e.editing=!1},function(t){console.log(t),e.error=t})}}}}),app.directive("lkrFieldText",function(){return{restrict:"EA",templateUrl:"directives/field-text.html",replace:!0,scope:{originalValue:"=value",fieldName:"@value",updateCb:"&",label:"@",placeholder:"@",allowEdit:"@"},link:function(e){e.editing=!1,e.editValue=e.originalValue,e.allowEdit="true"==e.allowEdit,e.editClick=function(){e.editValue=e.originalValue,e.editing=!0,e.error=""},e.okClick=function(){var t=e.fieldName;t.indexOf(".")>=0&&(t=t.split(".")[t.split(".").length-1]),e.updateCb({fieldName:t,fieldValue:e.editValue}).then(function(){e.editing=!1},function(t){console.log(t),e.error=t})}}}}),app.directive("lkrFieldTextarea",function(){return{restrict:"EA",templateUrl:"directives/field-textarea.html",replace:!0,scope:{originalValue:"=value",fieldName:"@value",updateCb:"&",label:"@",placeholder:"@",allowEdit:"@"},link:function(e){e.editing=!1,e.editValue=e.originalValue,e.allowEdit="true"==e.allowEdit,e.editClick=function(){e.editValue=e.originalValue,e.editing=!0,e.error=""},e.okClick=function(){var t=e.fieldName;t.indexOf(".")>=0&&(t=t.split(".")[t.split(".").length-1]),e.updateCb({fieldName:t,fieldValue:e.editValue}).then(function(){e.editing=!1},function(t){console.log(t),e.error=t})}}}}),app.directive("lkrField",["$timeout","apiService","$http",function(e,t){return{restrict:"EA",templateUrl:"directives/field.html",replace:!0,scope:{formMode:"@",field:"=",originalValue:"=value",fieldName:"@value",updateCb:"&",label:"@",placeholder:"@",type:"@",allowEdit:"@",radioValues:"="},controller:["$scope",function(){}],link:function(e){e.edit={editing:!1,formMode:"true"==e.formMode},e.allowEdit="true"==e.allowEdit,"date"==e.type&&angular.isDefined(e.originalValue)&&(e.edit.value=moment(e.value).format()),e.radioClick=function(t){e.edit.editing=!1,e.error="";var n=e.fieldName;n.indexOf(".")>=0&&(n=n.split(".")[n.split(".").length-1]),e.updateCb({fieldName:n,fieldValue:t}).then(function(){e.editing=!1},function(t){e.error=t})},e.editClick=function(){return"false"==e.allowEdit?!1:(jQuery.extend(e.edit.value,e.originalValue),e.edit.editing=!0,void(e.error=""))},e.loadUsers=function(e){return e.length<3?void 0:t.get(["user"],{ini:e})},e.okClick=function(){var t=e.fieldName,n=e.edit.value;"date"==e.type&&(n=angular.isUndefined(n)?"":moment(n).startOf("day").format()),t.indexOf(".")>=0&&(t=t.split(".")[t.split(".").length-1]),e.updateCb({fieldName:t,fieldValue:n}).then(function(){e.edit.editing=!1},function(t){console.log(t),e.error=t})}}}}]),app.directive("lkrFileEditor",["$upload","$timeout",function(e,t){return{restrict:"EA",templateUrl:"directives/file-editor.html",scope:{data:"=data",fileAccept:"@",fileEditorId:"=",caption:"@"},link:function(n,a,i){n.showPostButton=angular.isDefined(i.showPostButton),n.postButtonClick=function(){n.$emit("fileUpoadPostEvent")},n.fileIndex=0,angular.isDefined(n.data)||(n.data=[]),n.showPost="true"==n.showPost,n.selectClick=function(){t(function(){$("#myFileInputAll"+n.fileEditorId).click()})},n.getPreviewImg=function(e){return e>0?apiUrl+"/userfile/"+e+"/preview":void 0},n.removeClick=function(e){var t=_.findWhere(n.data,{id:e});t.status="deleted"},n.filterFn=function(e){return"deleted"!==e.status},n.formatFileSize=function(e){if(""==e||null==e)return"";var e=parseInt(e);return e>1e6?(e/1e6).toFixed(2)+" MB":e>1e3?(e/1e3).toFixed(2)+" KB":e+" Bytes"},n.onFileSelect=function(t){for(var a="",i=0;i<t.length;i++){n.fileIndex++,a=n.fileIndex+"-"+i,n.data.push({original_name:t[i].name,id:a,file_size:t[i].size,status:"w"});var o=t[i];o.id=a,n.upload=e.upload({url:apiUrl+"/file",data:{id:a,filedate:o.lastModifiedDate},file:o}).success(function(e){var t=_.findWhere(n.data,{id:e.data.id});e.success?("deleted"!=t.status&&(t.status="done"),t.id=e.data.code):t.status="error"}).error(function(e,t,a,i){var o=_.findWhere(n.data,{id:i.file.id});o.status="error"})}}}}}]),app.directive("lkrFileViewer",["$modal",function(e){return{restrict:"EA",templateUrl:"directives/file-viewer.html",replace:!0,scope:{data:"=data",contentid:"=contentid"},link:function(t){t.show=!1,t.openImg=function(n){t.image2View=apiUrl+"/userfile/"+n;e.open({templateUrl:"app/templates/lightbox.html",scope:t,windowClass:"img-modal"})},t.hasImages=function(){var e=_.findWhere(t.data,{file_type:"image"});return angular.isDefined(e)},t.hasFiles=function(){var e=_.findWhere(t.data,{file_type:"file"});return angular.isDefined(e)},t.formatDesc=function(e,n,a){return res="",""!=e&&(res=e+" - "),res=res+t.formatDate(a)+" ("+t.formatFileSize(n)+")"},t.formatDate=function(e){return moment(e).format("lll")},t.formatFileSize=function(e){if(""==e||null==e)return"";var e=parseInt(e);return e>1e6?(e/1e6).toFixed(2)+" MB":e>1e3?(e/1e3).toFixed(2)+" KB":e+" Bytes"},t.getPreviewImg=function(e){return apiUrl+"/file/"+e+"/preview"},t.getUrlToFile=function(e){return apiUrl+"/file/"+e}}}}]),app.directive("lkrLikes",["apiService","formatterService",function(e){return{restrict:"E",templateUrl:"directives/likes.html",scope:{likes:"=likes",objectId:"=objectId",likeCount:"=likeCount",btnClass:"@btnClass",className:"@className"},link:function(t){t.iLike=!1,t.getLikeList=function(){if(!angular.isUndefined(t.likes)){for(var e="",n=t.likes.length<20?"<br>":", ",a=0;a<t.likes.length;a++)""!=e&&(e+=n),e+=t.likes[a].user.full_name,t.likes[a].user.id==user.id&&(t.iLike=!0);return e}},t.onClick=function(){e.get(["like",t.className,t.objectId]).then(function(e){for(var n=-1,a=0;a<t.likes.length;a++)t.likes[a].user.id==user.id&&(n=a);!e&&n>=0&&t.likes.splice(n,1),e&&0>n&&t.likes.push({id:0,user:{id:user.id,full_name:user.fullname}}),t.iLike=e})}}}}]),app.directive("lkrLinkEditor",["apiService",function(e){return{restrict:"EA",replace:!0,templateUrl:"directives/link-editor.html",scope:{data:"=data",errors:"=errors"},link:function(t){t.linkClick=function(){t.data.done=!1,t.data.waiting=!0,t.data.title="",t.data.image="",t.data.description="",t.data.icon="",t.errors=null,e.post("content/geturl",{url:t.data.url}).then(function(e){t.data.title=e.title,t.data.image=e.image,t.data.description=e.description,t.data.url=e.url,t.data.icon=e.icon,t.data.done=!0,t.data.waiting=!1},function(e){t.data.done=!1,t.errors=e,t.data.waiting=!1},function(){t.data.done=!1,t.data.waiting=!1})},t.keyPress=function(){t.errors=null,t.data.done=!1},t.pasteLink=function(){setTimeout(function(){t.linkClick()},100)}}}}]),app.directive("lkrLinkViewer",function(){return{restrict:"EA",templateUrl:"directives/link-viewer.html",replace:!0,scope:{data:"=data"}}}),app.directive("lkrLocationEditor",["apiService",function(e){return{restrict:"EA",replace:!0,templateUrl:"directives/location-editor.html",scope:{data:"=data",errors:"=errors"},link:function(t){t.mapClick=function(n){t.data.done=n,t.data.waiting=!0,t.data.image="",t.errors=null,e.post("content/getStaticMap",{address:t.data.address,zoom:t.data.zoom,done:t.data.done}).then(function(e){t.data.image=e.image,t.data.done=!0,t.data.waiting=!1},function(e){t.data.done=!1,t.data.waiting=!1,t.errors=e},function(){t.data.done=!1,t.data.waiting=!1})},t.keyPress=function(){t.errors=null,t.data.done=!1}}}}]),app.directive("lkrLocationViewer",function(){return{restrict:"EA",templateUrl:"directives/location-viewer.html",replace:!0,scope:{data:"=data"}}}),app.directive("lkrMessageItem",["$q","apiService","formatterService","$sce",function(e,t,n,a){return{restrict:"EA",templateUrl:"directives/message-item.html",scope:{message:"=message"},link:function(e,t,i){e.showReply=!1,e.message.replyText="",e.formatter=n,e.body=a.trustAsHtml(e.message.body),e.sent=angular.isDefined(i.sent),e.showReplyClick=function(){e.showReply=!e.showReply},e.sendClick=function(){e.$emit("replyMessage",{id:e.message.id,body:e.message.replyText}),e.showReply=!1,e.message.replyText=""},e.markAsReadClick=function(){e.$emit("markMessageAsRead",e.message.id)}}}}]),app.directive("morrisChart",function(){return{restrict:"E",replace:!0,template:"<div></div>",scope:{options:"="},link:function(e,t){e.doChart=function(e){if(angular.isDefined(e)){var n=angular.copy(e);t.empty(),n.element=t,n.ykeys=[];for(var a=0;a<n.skeys.length;a++)n.ykeys.push("s"+n.skeys[a]);if("bar"==n.chartType){new Morris.Bar(n)}if("line"==n.chartType){new Morris.Line(n)}if("area"==n.chartType){new Morris.Area(n)}if("donut"==n.chartType){for(var i=[],a=0;a<n.data.length;a++)i.push({label:n.data[a].xlabel,value:n.data[a].s1});n.data=i;{Morris.Donut(n)}}}},e.$watch("options",function(t){e.doChart(t)},!0)}}}),app.directive("lkrPollEditor",function(){return{restrict:"EA",templateUrl:"directives/poll-editor.html",scope:{data:"=data"},link:function(e){e.addRowClick=function(){e.data.options.push("")},e.delRowClick=function(t){e.data.options.length>1&&e.data.options.splice(t,1)}}}}),app.directive("lkrPollViewer",["apiService",function(e){return{restrict:"EA",templateUrl:"directives/poll-viewer.html",replace:!0,scope:{data:"=data",contentid:"=contentid",votes:"=votes",zoom:"="},link:function(t){t.editing=!1,t.newOption="",t.myIndex=null,t.addOptionClick=function(){t.newOption="",t.editing=!0},t.okClick=function(){""!=t.newOption&&e.post(["vote",t.contentid],{option:t.newOption}).then(function(e){t.editing=!1,t.data=e,t.init()})},t.cancelClick=function(){t.newOption="",t.editing=!1},t.init=function(){for(t.options=[],t.data.voters=[],t.total=0,t.data.values=[],i=0;i<t.data.options.length;++i)t.data.values[i]=0,t.data.voters[i]="";angular.forEach(t.votes,function(e){t.total++,t.data.values[e.choice]=t.data.values[e.choice]+1,""!=t.data.voters[e.choice]&&(t.data.voters[e.choice]=t.data.voters[e.choice]+"<br>"),t.data.voters[e.choice]=t.data.voters[e.choice]+e.user.full_name,e.user.id==user.id&&(t.myIndex=e.choice)})},t.voteClick=function(n){e.get(["vote",t.contentid,parseInt(n)]).then(function(e){t.votes=e.votes,t.init()})},t.getPercent=function(e){if(0==t.total)return"";if(0==e)return"";var n=Math.floor(100*e/t.total);return"("+n+"%)"},t.getValue=function(e){if(0==t.total)return"";var n=Math.floor(100*e/t.total);return"width: "+n+"%"},t.init()}}}]),app.factory("Popup",["$window","$document","$timeout","$compile","$parse",function(e,t,n,a,i){function o(e){p&&!$.contains(p.el[0],e.target)&&r()}function r(){if(p){var e=p;p=null,n(function(){i(e.options.popupHidden)(e.scope),e.el.hide().remove(),t.off("click",o)})}}function s(e,t){for(var n in t)e[n]||(e[n]=t[n])}function l(e,t,a){s(a,{popupPlacement:"right",popupClass:"",popupShown:"",popupHidden:"",popupOverlap:5}),t.popupView=a.popupShow,t.hidePopover=r,n(function(){u(e,t,a)})}function c(n){var a=n[0].getBoundingClientRect();return{width:a.width||n.prop("offsetWidth"),height:a.height||n.prop("offsetHeight"),top:a.top+(e.pageYOffset||t[0].documentElement.scrollTop),left:a.left+(e.pageXOffset||t[0].documentElement.scrollLeft)}}function d(n,a,r,s,l){var d=null,u=null,p=null,f=c(a),h=l.popupPlacement,g=l.popupClass,v=e.innerHeight-2*m,k=l.popupOverlap;if("right"===h)p={top:f.top+f.height/2,left:f.left+f.width-k},d={top:p.top-r.height()/2,left:p.left},d.top=Math.max(m,d.top),u={top:p.top-d.top};else if("left"===h)p={top:f.top+f.height/2,left:f.left+k-2},d={top:p.top-r.height()/2,left:p.left-r.width()},d.top=Math.max(m,d.top),u={top:p.top-d.top};else if("bottom"===h)p={top:f.top+f.height,left:f.left+f.width/2},d={top:p.top-k,left:p.left-r.width()/2},d.left=Math.max(m,d.left),v-=d.top,u={left:p.left-d.left};else{if("top"!==h)throw new Error("Unsupported placement "+h);p={top:f.top-r.outerHeight(),left:f.left+f.width/2},d={top:p.top+k,left:p.left-r.width()/2},d.left=Math.max(m,d.left),v-=d.top,u={left:p.left-d.left}}r.removeClass("left right bottom top"),r.addClass(h),g&&r.addClass(g),r.css({top:d.top+"px",left:d.left+"px",display:"block",maxHeight:v});var C=r.find(".popover-title"),w=r.find(".popover-content"),S=r.find(".popover-footer");w.css({maxHeight:v-S.outerHeight()-C.outerHeight()-4,overflow:"auto"}),u&&s.css(u),r.removeClass("hide"),t.on("click",o),i(l.popupShown)(n)}function u(e,i,o){var r=a(f)(i);p={el:r,options:o,scope:i};var s=t.find("body");s.append(r);var l=$("<div />",{"class":"arrow"});r.children(".arrow").remove(),r.append(l),i.$reposition=function(){n(function(){d(i,e,r,l,o)})}}var p=null,f='<div class="popover"><div ng-include="popupView" onload="$reposition()"></div></div>',m=10;return{show:l,close:r}}]),app.directive("popupShow",["Popup","$parse","$timeout",function(e,t,n){return{restrict:"A",scope:!0,link:function(a,i,o){i.click(function(){n(function(){e.close();var n=t(o.popupIf||"true");n(a)&&e.show(i,a,o)})})}}}]),app.directive("popupAutoShow",["Popup","$parse",function(e,t){return{restrict:"A",link:function(n,a,i){n.$watch(i.popupAutoShow,function(o){if(o){e.close();var r=t(i.popupIf||"true");r(n)&&e.show(a,n,i)}})}}}]),app.directive("lkrTableEditor",function(){return{restrict:"EA",replace:!0,templateUrl:"directives/table-editor.html",scope:{tableData:"=data"},link:function(e){e.showPaste=!1,e.pasteData="",e.newRowClick=function(){for(var t=[],n=0;n<e.tableData.cols.length;n++)t.push("");e.tableData.rows.push(t)},e.delColClick=function(){if(e.tableData.cols.length>1){e.tableData.cols.splice(e.tableData.cols.length-1,1);for(var t=0;t<e.tableData.rows.length;++t)e.tableData.rows[t].splice(e.tableData.rows[t].length-1,1)}},e.delRowClick=function(t){e.tableData.rows.splice(t,1)},e.processPaste=function(){for(var t=e.pasteData.split("\n"),n=[],a=0;a<t.length;a++)n.push(t[a].split("	"));if(e.tableData.cols=[],e.tableData.rows=[],n.length>0){for(a=0;a<n[0].length;a++)e.tableData.cols.push({type:"text",title:n[0][a]});for(a=1;a<n.length;a++){var i=[];for(j=0;j<n[a].length;j++)i.push(n[a][j]);e.tableData.rows.push(i)}}if(0==e.tableData.rows.length)for(e.tableData.rows.push([]),a=0;a<e.tableData.cols.length;a++)e.tableData.rows[0].push("");e.showPaste=!1,e.pasteData="",e.$apply()},e.handlePaste=function(){setTimeout(function(){e.processPaste()},100)},e.newColClick=function(){e.tableData.cols.push({type:"text",title:translations.NEW_COLUMN});for(var t=0;t<e.tableData.rows.length;t++)e.tableData.rows[t].push("")}}}}),app.directive("lkrTableViewer",["apiService",function(){return{restrict:"EA",templateUrl:"directives/table-viewer.html",replace:!0,scope:{data:"=data",contentid:"=",zoom:"@"},link:function(e){e.getExportUrl=function(){return apiUrl+"/csv/"+e.contentid}}}}]),app.directive("lkrTaskList",["$timeout","formatterService","$stateParams",function(e,t,n){return{restrict:"EA",templateUrl:"directives/task-list.html",scope:{tasks:"=tasks",contentId:"@",filter:"="},link:function(a){a.newTaskPanel=-1,a.spaceCode=n.spaceCode,a.prepareNewTask=function(){a.newTask={user_id:user.id,priority:1,state:0,space_code:a.spaceCode,files:[],error:[]}},a.$on("taskMenuChanged",function(){a.newTaskPanel=-1}),a.list={field:"due_date_group"},a.getGroupText=function(e){if(""!=a.list.field){if("state"==a.list.field){var t=[translations.NOT_STARTED,translations.IN_PROGRESS,translations.SUSPENDED,translations.COMPLETED,translations.CANCELED];return t[e.state]}if("priority"==a.list.field){var n=[translations.LOW,translations.NORMAL,translations.HIGH,translations.CRITICAL];return n[e.priority]}if("due_date_group"==a.list.field){var i=[translations.OVERDUE,translations.TODAY,translations.TOMORROW,translations.NEXT_7_DAYS,translations.LATER,translations.SOMEDAY];return i[e.due_date_group]}return"space"==a.list.field?e.space:""}},a.formatter=t,a.$on("taskInsertEvent",function(e,t){a.tasks.push(t),a.newTaskPanel=-1}),a.prepareNewTask(),a.$on("newTaskClickEvent",function(){a.newTaskClick()}),a.newTaskClick=function(){-1==a.newTaskPanel?(a.prepareNewTask(),a.newTaskPanel=0):a.newTaskPanel=-1},a.$on("taskDeleteEvent",function(t,n){a.taskListPanel=-1,e(function(){var e=findWithAttr(a.tasks,"id",n);e>=0&&a.tasks.splice(e,1),a.getCounters()},100)}),a.$on("taskArchiveEvent",function(t,n){a.taskListPanel=-1,e(function(){var e=findWithAttr(a.tasks,"id",n);e>=0&&a.tasks.splice(e,1),a.getCounters()},100)}),a.$on("taskCancelEvent",function(){a.newTaskPanel=-1})}}}]),app.directive("lkrTask",["$q","apiService","formatterService","$stateParams",function(e,t,n,a){return{restrict:"EA",templateUrl:"directives/task.html",scope:{task:"=task",contentId:"@"},link:function(e,i,o){e.spaceCode=a.spaceCode,e.noComments=angular.isDefined(o.noComments),e.$watch("task",function(t){t&&(e.edit={editing:"",owner:e.task.user_id==user.id,newRecord:angular.isDefined(o.newRecord),error:[],task:{}},jQuery.extend(e.edit.task,e.task))},!0),e.fileEditorId="feNewTask"+e.contentId+e.spaceCode,e.formatter=n,e.states=[{id:0,caption:translations.NOT_STARTED,icon:"fa-stop"},{id:1,caption:translations.IN_PROGRESS,icon:"fa-play"},{id:2,caption:translations.SUSPENDED,icon:"fa-pause"},{id:3,caption:translations.COMPLETED,icon:"fa-check"},{id:4,caption:translations.CANCELED,icon:"fa-times"}],e.priorities=[{id:0,caption:translations.LOW},{id:1,caption:translations.NORMAL},{id:2,caption:translations.HIGH},{id:3,caption:translations.CRITICAL}],e.editClick=function(t){e.edit.task=JSON.parse(JSON.stringify(e.task)),e.edit.error={},e.edit.editing=t},e.archiveTaskClick=function(){t.get(["task/archive",e.task.id]).then(function(){e.$emit("taskArchiveEvent",e.task.id),e.$emit("taskUpdateCounters")})},e.confirmDeleteClick=function(){t.delete(["task",e.task.id]).then(function(){e.$emit("taskDeleteEvent",e.task.id),e.$emit("taskUpdateCounters")})},e.cancelClick=function(){e.edit.error=[],e.$emit("taskCancelEvent")},e.postClick=function(){var n=e.task;""!=e.contentId&&(n.content_id=e.contentId),angular.isDefined(a.spaceCode)&&(n.space_code=a.spaceCode),t.post(["task"],n).then(function(t){e.$emit("taskInsertEvent",t),e.$emit("taskUpdateCounters")},function(t){e.edit.error=t})},e.updateRadio=function(n,a){e.edit.newRecord?e.task[n]=a:t.put(["task",e.task.id],{field:n,value:a}).then(function(){e.edit.editing="",e.task[n]=a,e.$emit("taskUpdateCounters")},function(t){e.edit.error=t})},e.updateField=function(n){angular.isUndefined(e.edit.task[n])&&(e.edit.task[n]=null),t.put(["task",e.task.id],{field:n,value:e.edit.task[n]}).then(function(t){"assigned_to"==n?(e.task.assigned_to=t.assigned_to,e.task.assignments=t.assignments,e.task.my=t.my,e.task.delegated=t.delegated):"due_date"==n?(e.task[n]=e.edit.task[n],e.task.due_date_group=t.due_date_group):e.task[n]=angular.isUndefined(e.edit.task[n])?null:e.edit.task[n],e.$emit("taskUpdateCounters"),e.edit.editing=""},function(t){e.edit.error=t})},e.listAssignments=function(e){return e&&e.length>0?_.pluck(e,"full_name").join(", "):void 0},e.loadUsers=function(e){return e.length<3?void 0:t.get(["user"],{ini:e})},e.allowEdit=function(t){if("state"==t){if(e.task.user_id==user.id)return!0;for(var n=0;n<e.task.assigned_to.length;n++)if(e.task.assigned_to[n].id==user.id)return!0;return!1}return e.task.user_id==user.id}}}}]),app.controller("adminCtrl",["$scope","spaceFactory","formatterService","$modal","apiService","growl","$timeout",function(e,t,n,a,i,o,r){e.formatter=n,e.users=[],e.viewIndex=0,e.spacesOrder="title",e.sort={column:"full_name",asc:!0},e.newUserPanel=!0,e.newuser={full_name:"",email:"",password:"",password_confirmation:"",admin:!1,create_spaces:!0},e.newUserFormClick=function(){e.newUserPanel=!e.newUserPanel},e.newUserFormCancelClick=function(){e.newuser={full_name:"",email:"",password:"",password_confirmation:"",admin:!1,create_spaces:!0},e.newUserPanel=!e.newUserPanel},e.newUserFormOkClick=function(){i.post("newuserform",e.newuser).then(function(){e.newUserPanel=!e.newUserPanel,e.newuser={full_name:"",email:"",password:"",password_confirmation:"",admin:!1,create_spaces:!0},e.loadUsers()
},function(t){e.errors=t})},e.saveConfig=function(){i.put("config",e.appInfo).then(function(){r(function(){o.success("New configuration saved. Please, refresh your page.")},1e3)})},e.loadSysLog=function(){i.get("syslog").then(function(t){e.syslog=t})},e.deleteLog=function(){i.delete("syslog").then(function(){e.syslog=""})},e.spaceStateClick=function(t){i.put(["adminspaces",t.id,"activate"]).then(function(n){console.log("data",n),t.active=n,e.$emit("spaceListChanged")})},e.setOrder=function(t){e.sort.column==t?e.sort.asc=!e.sort.asc:(e.sort.column=t,e.sort.asc=!1)},e.loadUsers=function(){i.get("adminuser").then(function(t){e.users=t.data,e.userCounters=t.extra})},e.loadAppInfo=function(){i.get("admin/appinfo").then(function(t){e.appInfo=t,console.log("res",e.appInfo)})},e.upgradeClick=function(){i.get("admin/upgrade").then(function(){})},e.confirmDeleteClick=function(t,n){n==translations.DELETE_SPACE_PHRASE&&i.delete(["space",t]).then(function(){e.$emit("spaceListChanged"),e.loadSpaces()})},e.confirmModerator=function(e){i.put(["user/makemoderator",e]).then(function(){})},e.getAppVersion=function(){return appVersion},e.loadSpaces=function(){i.get("adminspaces").then(function(t){e.spaces=t})},e.errors={},e.newUser={waiting:!1,email:""},e.runMaintenanceClick=function(){i.get("admin/maintenance")},e.adminClick=function(t){i.put(["user/admin",t]).then(function(n){var a=findWithAttr(e.users,"id",t);e.users[a].admin=n})},e.createSpacesClick=function(t){i.put(["user/createspaces",t]).then(function(n){var a=findWithAttr(e.users,"id",t);e.users[a].create_spaces=n})},e.reNewClick=function(t){i.put(["user/renew",t]).then(function(n){var a=findWithAttr(e.users,"id",t);e.users[a]=n})},e.updateStateClick=function(t,n){i.put(["user/state",t,n]).then(function(n){var a=findWithAttr(e.users,"id",t);n=parseInt(n),3>n?e.users[a].state=n:e.users.splice(a,1)})},e.newUserClick=function(){""!=e.newUser.email&&(e.newUser.waiting=!0,i.post("user",{email:e.newUser.email}).then(function(){e.loadUsers(),e.newUser.waiting=!1,e.errors={},e.newUser={waiting:!1,email:""},o.success(translations.INVITATION_SENT)},function(t){e.newUser.waiting=!1,e.errors=t}))},e.loadUsers(),e.loadSpaces(),e.loadAppInfo()}]),app.controller("calendarCtrl",["$scope","spaceFactory","formatterService","$timeout","apiService","$modal","contentService",function(e,t,n,a,o,r,s){e.formatter=n;{var l=new Date;l.getDate(),l.getMonth(),l.getFullYear()}e.eventSources=[{events:[],color:"#008BBC",textColor:"white"},{events:[],color:"#E862AC",textColor:"white"}],e.renderCalender=function(e){e.fullCalendar("render")},e.alertOnEventClick=function(t){"event"==t.type?s.getOne(t.id).then(function(t){e.event=t;r({template:"partials/modal-event.html",scope:e,animation:"am-fade-and-slide-top",show:!0})}):"task"==t.type&&o.get(["task",t.id]).then(function(t){e.task=t;r({template:"partials/modal-task.html",scope:e,animation:"am-fade-and-slide-top",show:!0})})},e.eventSources=[{events:[],color:"#008BBC",textColor:"white"},{events:[],color:"#E862AC",textColor:"white"}],e.loadEvents=function(){o.get("calendar").then(function(t){for(i=0;i<t.events.length;++i){var n=new Date(t.events[i].start),a=new Date(t.events[i].end);e.eventSources[0].events.push({title:t.events[i].title,start:n,end:a,allDay:t.events[i].allDay,id:t.events[i].id,type:"event"})}for(i=0;i<t.tasks.length;++i){var n=new Date(t.tasks[i].start),a=new Date(t.tasks[i].end);e.eventSources[1].events.push({title:t.tasks[i].title,start:n,end:a,allDay:t.tasks[i].allDay,id:t.tasks[i].id,type:"task"})}})},e.renderCalender=function(e){e.fullCalendar("render")},e.loadEvents(),e.uiConfig={calendar:{editable:!1,height:750,lang:locale,header:{left:"title",center:"",right:"today prev,next"},eventClick:e.alertOnEventClick}}}]),app.controller("homeCtrl",["$scope","$state","$cacheFactory","$timeout","spaceFactory","formatterService","$modal","apiService",function(e,t,n,a,i,o,r,s){e.formatter=o,e.features=[{value:"drive",text:translations.DRIVE},{value:"wikis",text:translations.WIKIS},{value:"tasks",text:translations.TASKS},{value:"chat",text:translations.CHAT}],e.spaces=[],e.createSpaceClick=function(){e.editSpace={title:"",description:"",options:{features:["drive","wikis","tasks","chat"]},access:"PU"},e.error=null,e.spaceForm=r({template:"partials/modal-space-edit.html",title:"New space",scope:e,animation:"am-fade-and-slide-top",show:!0})},e.canCreateSpace=function(){return 1==user.cs},e.editSpaceOkClick=function(){s.post(["space"],e.editSpace).then(function(n){e.spaceForm.hide(),e.$emit("spaceListChanged"),t.go("space.stream",{spaceCode:n})},function(t){e.error=t})},e.zoomClick=function(e){t.go("post",{contentId:e})},e.testClick=function(){i.loadSpaces().then(function(t){e.activity=t})},e.joinClick=function(n){s.put(["space",n,"join"]).then(function(){t.go("space.stream",{spaceCode:n}),e.$emit("spaceListChanged")})},e.icons=["fa fa-comment","fa fa-link","fa fa-table","fa fa-bar-chart","fa fa-check-square","fa fa-calendar","fa fa-map-marker"],e.getLogoutUrl=function(){return siteUrl+"/logout"},e.gotoSpace=function(e){a(function(){t.go("space.stream",{spaceCode:e})})},e.loadSpaces=function(){s.get("home").then(function(t){var n=$(".btn-info").css("background-color");e.spaces=t.spaces,e.join=t.join,a(function(){angular.forEach(t.spaces,function(e){$("#spark_"+e.code).sparkline(e.counter,{disableTooltips:!0,disableHighlight:!0,type:"bar",barColor:n,height:"40px",barWidth:"15",barSpacing:"2"})})})})},e.loadContent=function(){s.get("home/content").then(function(t){e.contents=t})},e.events=[],h_cal||s.get(["event"],{view:"short"}).then(function(t){e.events=t}),e.tasks=null,s.get("task/counters").then(function(t){e.tasks=t}),e.loadSpaces(),e.loadContent()}]),app.controller("mainCtrl",["$scope","$state","spaceFactory","formatterService","$modal","apiService","$timeout",function(e,t,n,a,i,o,r){e.formatter=a,e.sp={spaceSearch:""},e.userProfile={},e.activePage=0,e.msg={privateMessage:""},e.msgCount=0,e.spaceFactory=n,e.spaces=[],e.loadSpaces=function(){o.get("space").then(function(t){e.spaces=t,e.spaceFactory.spaceList(t)})},e.loadSpaces(),e.search={text:""},e.doSearch=function(){""!=e.search.text&&(t.go("search",{query:e.search.text}),e.search={text:""})},e.sendMessageClick=function(){""!=e.msg.privateMessage&&o.post("message",{to_id:e.userProfile.id,body:e.msg.privateMessage}).then(function(){e.msg={privateMessage:""}})},e.$on("peopleDialogEvent",function(t,n){o.getCached(["profile",n],null,!0).then(function(t){e.userProfile=t;i({template:"partials/modal-people.html",scope:e,animation:"am-fade-and-slide-top",show:!0})})}),e.$on("messageCountChanged",function(){e.mainPool()}),e.gotoSpace=function(n){e.spaceSearch="",r(function(){e.sp={spaceSearch:""},t.go("space.stream",{spaceCode:n})},200)},e.gotoPage=function(e){r(function(){t.go(e)})},e.$on("spaceListChanged",function(){e.loadSpaces()}),e.getLogoutUrl=function(){return siteUrl+"/logout"},e.mainPool=function(){o.get("mainpool").then(function(t){t.msgs>e.msgCount&&sndBell.play(),e.msgCount=t.msgs,r(e.mainPool,6e4)})},e.mainPool()}]),app.controller("messagesCtrl",["$scope","$state","$cacheFactory","spaceFactory","formatterService","$modal","apiService",function(e,t,n,a,i,o,r){e.formatter=i,e.msgs=[],e.newMessage={to:[],body:"",panel:-1},e.viewIndex=0,e.viewClick=function(t){e.viewIndex=t,e.loadMessages(1==e.viewIndex)},e.loadMessages=function(t){var n=null;angular.isDefined(t)&&t&&(n={sent:!0}),r.get("message",n).then(function(t){e.msgs=t})},e.checkAllClick=function(t){angular.forEach(e.msgs,function(e){e.read||(e.checked=t)})},e.markAllReadClick=function(){angular.forEach(e.msgs,function(e){angular.isDefined(e.checked)&&e.checked&&r.put(["message",e.id]).then(function(t){e.read=t,e.checked=!1})}),e.$emit("messageCountChanged")},e.newMessageClick=function(){e.newMessage.panel=e.newMessage.panel=0==e.newMessage.panel?-1:0,e.newMessage.to=[],e.newMessage.body=""},e.sendClick=function(){""!=e.newMessage.body&&0!=e.newMessage.to.length&&r.post("message",{to_id:e.newMessage.to,body:e.newMessage.body}).then(function(){e.newMessage={to:[],body:"",panel:-1},1==e.viewIndex&&e.loadMessages(!0)})},e.loadUsers=function(e){return e.length<3?void 0:r.get(["user"],{ini:e})},e.$on("replyMessage",function(t,n){var a=_.findWhere(e.msgs,{id:n.id}),i=a.from_id;r.post("message",{to_id:i,body:n.body})}),e.$on("markMessageAsRead",function(t,n){var a=_.findWhere(e.msgs,{id:n});r.put(["message",n]).then(function(t){a.read=t,a.checked=!1,e.$emit("messageCountChanged")})}),e.loadMessages()}]),app.controller("peopleCtrl",["$scope","apiService","formatterService",function(e,t,n){e.formatter=n,e.showPhone=showPhone,e.showOrg=showOrg,e.order="full_name",t.getCached("profile").then(function(t){e.users=t.data,e.customFields=t.extra}),e.setOrder=function(t){e.order="custom_"+t},e.peopleClick=function(t){e.$emit("peopleDialogEvent",t)}}]),app.filter("peopleFilter",function(){return function(e,t,n){if(e){if(t){var a=t.toLowerCase();return e.filter(function(e){return result=e.full_name.toLowerCase().indexOf(a)>-1,e.organization&&(result=result||e.organization.toLowerCase().indexOf(a)>-1),e.position&&(result=result||e.position.toLowerCase().indexOf(a)>-1),angular.forEach(n,function(t){e["custom_"+t.name]&&(result=result||e["custom_"+t.name].toLowerCase().indexOf(a)>-1)}),result})}return e}}}),app.controller("postCtrl",["$scope","$state","$stateParams","$previousState","contentService","formatterService",function(e,t,n,a,i,o){e.people=null,e.zoom=!0,e.formatter=o,e.$on("contentDeletedEvent",function(){a.go()}),i.getOne(n.contentId).then(function(t){e.content=t},function(){a.go()})}]),app.controller("profileCtrl",["$scope","spaceFactory","formatterService","$upload","$timeout","$locale","apiService","usSpinnerService",function(e,t,n,a,i,o,r,s){e.formatter=n,e.password={old:"","new":"",conf:""},e.profileFields=profileFields,e.dateFormat=o.DATETIME_FORMATS.longDate,r.get(["profile",user.id]).then(function(t){e.profile=t;for(var a=0;a<t.custom_fields.length;a++)"date"==t.custom_fields[a].type&&(e.profile["custom_"+t.custom_fields[a].name]=moment(e.profile["custom_"+t.custom_fields[a].name]).toDate());e.avatar=n.getAvatar(e.profile.id)}),e.updateSettingsClick=function(){r.post("profile/settings",e.profile).then()},e.updateProfileClick=function(){e.errors=null,r.post("profile",e.profile).then(function(){},function(t){e.errors=t})},e.onFileSelect=function(t){var o=t[0];s.spin("avatarSpinner"),a.upload({url:apiUrl+"/profile/avatar",file:o}).success(function(){i(function(){var t=Math.floor(1e6*Math.random()+1);e.profile.avatar=e.avatar=n.getAvatar(e.profile.id)+"?"+t,s.stop("avatarSpinner")},1e3)}).error(function(){s.stop("avatarSpinner")})},e.updatePassword=function(){e.errors=null,r.post("profile/password",e.password).then(function(){e.password={old:"","new":"",conf:""}},function(t){e.errors=t})},e.scrollTo=function(e){i(function(){$("html,body").animate({scrollTop:$("#"+e).offset().top-60},600)})},e.photoClick=function(){i(function(){$("#photoEditor").click()})}}]),app.controller("searchCtrl",["$scope","$state","$stateParams","$timeout","formatterService","$modal","apiService",function(e,t,n,a,i,o,r){e.formatter=i,e.searchText=n.query,e.results=[],e.icons=["fa fa-comment","fa fa-link","fa fa-table","fa fa-bar-chart","fa fa-check-square","fa fa-calendar","fa fa-map-marker"],e.newSearch=function(){console.log("="),""!=e.searchText&&t.go("search",{query:e.searchText})},e.search=function(){r.get("search",{query:e.searchText}).then(function(t){e.results=t})},e.gotoSpace=function(e){a(function(){t.go("space.stream",{spaceCode:e})})},e.zoomClick=function(e){t.go("post",{contentId:e})},e.search()}]),app.controller("singleTaskCtrl",["$scope","$state","$stateParams","$previousState","apiService","formatterService",function(e,t,n,a,i,o){e.formatter=o,e.taskId=n.taskId,e.task=null,i.get(["task"],{task_id:e.taskId}).then(function(t){e.task=t[0]}),e.goBack=function(){a.go()}}]),app.controller("spaceAdminCtrl",["$scope","$state","$stateParams","$previousState","spaceFactory","apiService","growl","spaceFactory","formatterService","$modal",function(e,t,n,a,i,o,r,i,s,l){e.currentSpace=i,e.editSpace={},e.users=[],e.usersOrder="full_name",e.formatter=s,e.features=[{value:"drive",text:translations.DRIVE},{value:"wikis",text:translations.WIKIS},{value:"tasks",text:translations.TASKS},{value:"chat",text:translations.CHAT}];var c;e.editSpaceClick=function(){e.editSpace={title:e.currentSpace.title(),description:e.currentSpace.description(),options:JSON.parse(JSON.stringify(e.currentSpace.options())),access:e.currentSpace.access()},c=l({template:"partials/modal-space-edit.html",scope:e,animation:"am-fade-and-slide-top",show:!0})},e.switchRoleClick=function(t){o.put(["user","switchrole",t,n.spaceCode]).then(function(n){if(1==n){var a=findWithAttr(e.users,"id",t);e.users.splice(a,1)}else{var i=_.findWhere(e.users,{id:t});i.role=n}})},e.confirmDeleteClick=function(a){a==translations.DELETE_SPACE_PHRASE&&o.delete(["space",n.spaceCode]).then(function(){t.go("home"),e.$emit("spaceListChanged")})},e.editSpaceOkClick=function(){o.put(["space",n.spaceCode],e.editSpace).then(function(){c.hide(),e.currentSpace.invalidateSpaceCache(),e.currentSpace.setCurrent(n.spaceCode),e.$emit("spaceListChanged")})},e.loadUsers=function(){o.get(["space",n.spaceCode,"allusers"]).then(function(t){e.users=t})},e.$on("newUserInvited",function(){e.loadUsers()}),e.inviteClick=function(){e.$parent.inviteUsers()},e.$parent.selected=4,e.loadUsers()}]),app.controller("spaceCtrl",["$scope","$state","$stateParams","$timeout","spaceFactory","apiService","$modal",function(e,t,n,a,i,o,r){e.chat=[],e.chatFromId=0,e.currentSpace=i,i.setCurrent(n.spaceCode),e.modules=modules,e.selected=0,e.chatMsg={text:""},e.inviteUsers=function(){o.get(["space",n.spaceCode,"nousers"]).then(function(t){e.usersToInvite=t;r({template:"partials/modal-space-invite.html",scope:e,animation:"am-fade-and-slide-top",show:!0})})},e.inviteOkClick=function(){for(var t=[],a=0;a<e.usersToInvite.length;++a)angular.isDefined(e.usersToInvite[a].checked)&&e.usersToInvite[a].checked&&t.push(e.usersToInvite[a].id);t.length>0&&o.post(["user","invite",n.spaceCode],{users:t}).then(function(){e.$broadcast("newUserInvited")})},e.chatSend=function(){console.log("chatsend",e.chatMsg.text),e.chatEvent(e.chatMsg.text),e.chatMsg={text:""}},e.chatEvent=function(t){if(!(e.currentSpace.options().features.indexOf("chat")<0)){var i={fromid:e.chatFromId};t&&(i.message=t),o.get(["chat",n.spaceCode],i).then(function(t){t.length>0&&(angular.forEach(t,function(t){t.id>e.chatFromId&&e.chat.push(t)}),e.chatFromId=t[t.length-1].id,a(function(){angular.isUndefined($("#chatpanel")[0])||$("#chatpanel").scrollTop($("#chatpanel")[0].scrollHeight)}));var n=0==t.length?12e3:6e3;s=a(e.chatEvent,n)})}},e.$on("$destroy",function(){a.cancel(s)});var s=a(e.chatEvent,4e3)}]),app.controller("spaceFilesCtrl",["$scope","$state","$stateParams","$previousState","apiService","growl","spaceFactory","formatterService","$popover",function(e,t,n,a,o,r,s,l,c){e.folders=[],e.menuIndex=-1,e.appending=!1,e.editing=!1,e.editFolder="",e.newFiles=[],e.list={sortField:"1"},e.sort={column:"file_name",asc:!0},e.filter="",e.busy=!0,e.page=0,e.currentSpace=s,e.formatter=l,e.viewer={mode:"table"},e.realFolders=[],e.setOrder=function(t){e.sort.column==t?e.sort.asc=!e.sort.asc:(e.sort.column=t,e.sort.asc=!1),e.loadFiles(!0)},e.menuIndex=-1,e.cancelClick=function(){e.appending=!1},e.confirmRenameClick=function(t){""!=t&&o.put(["folder",e.selectedFolder.id],{name:t}).then(function(){var t=angular.copy(e.selectedFolder.id);e.loadFolders(t)})},e.batchDeleteClick=function(){angular.forEach(e.files,function(t){"1"==t.checked&&(l.isMe(t.user_id)||e.currentSpace.role()>2)&&o.delete(["file",t.code]).then(function(){e.loadFiles(!0)})})},e.confirmDeleteFileClick=function(t){o.delete(["file",t]).then(function(){e.loadFiles(!0)})},e.getUrlToFile=function(e){return apiUrl+"/file/"+e},e.confirmDeleteClick=function(){o.delete(["folder",e.selectedFolder.id]).then(function(){e.loadFolders(),e.selectedFolder=e.folders[0],e.menuIndex=0})},e.$on("fileUpoadPostEvent",function(){o.post(["folder",e.selectedFolder.id],{files:e.newFiles}).then(function(){e.newFiles=[],e.loadFiles(!0)})}),e.okClick=function(){var t=0;(angular.isDefined(e.rootFolder)||e.selectedFolder.id>0)&&0==e.rootFolder&&(t=e.selectedFolder.id),o.post(["folder"],{space_code:n.spaceCode,name:e.editFolder,parent_id:t}).then(function(n){n.childs=[],t>0?(n.path=e.selectedFolder.path+"/"+e.editFolder,e.selectedFolder.childs.push(n)):(n.path=e.editFolder,e.folders.push(n)),e.realFolders=angular.copy(e.folders),e.realFolders.shift(),e.editFolder="",e.rootFolder=1}),e.appending=!1},e.newFolderClick=function(){e.editFolder="",e.appending=!0},e.loadFolders=function(){o.get(["folder"],{space_code:n.spaceCode}).then(function(t){e.folders=t,e.realFolders=angular.copy(t),e.folders.splice(0,0,{id:0,name:translations.STREAM_FILES,childs:[],path:translations.STREAM_FILES}),e.selectedFolder=t[0]})},e.paging=function(){e.busy||e.page<0||(e.page++,e.loadFiles(!1))},e.filterKeyPress=function(){""==e.filter&&e.loadFiles(!0)},e.search=function(){e.loadFiles(!0)},e.checkAllClick=function(t){console.log("check"),angular.forEach(e.files,function(e){e.checked=t})},e.confirmBatchCopy=function(t){console.log("mcopy",t),angular.isUndefined(t)||t!=e.selectedFolder.id&&angular.forEach(e.files,function(e){console.log("f",e),"1"==e.checked&&o.put(["file",e.code,"copy",t]).then(function(){r.success(e.file_name+" "+translations.DONE)})})},e.confirmBatchMove=function(t){angular.isUndefined(t)||t!=e.selectedFolder.id&&angular.forEach(e.files,function(n){"1"==n.checked&&(l.isMe(n.user_id)||e.currentSpace.role()>2)&&o.put(["file",n.code,"move",t]).then(function(){r.success(n.file_name+" "+translations.DONE),e.loadFiles(!0)})})},e.batchCopyClick=function(t){console.log(t.target);var n=_.filter(e.files,function(e){return"1"==e.checked});if(n.length){var a=c(angular.element(t.target),{title:translations.COPY_TO,content:n.length,template:"partials/pop-copy-multiple-file.html",placement:"bottom",container:"body",animation:"am-fade",trigger:"manual",autoClose:!0,show:!0});a.$scope.okCaption=translations.COPY,a.$scope.folders=e.realFolders,a.$scope.treeOptions=e.treeOptions,a.$scope.okClick=e.confirmBatchCopy,a.$promise.then(a.show)}},e.batchMoveClick=function(t){var n=_.filter(e.files,function(e){return"1"==e.checked});if(n.length){var a=c(angular.element(t.target),{title:translations.MOVE_TO,content:n.length,template:"partials/pop-copy-multiple-file.html",placement:"bottom",container:"body",animation:"am-fade",trigger:"manual",autoClose:!0,show:!0});a.$scope.okCaption=translations.MOVE,a.$scope.folders=e.realFolders,a.$scope.treeOptions=e.treeOptions,a.$scope.okClick=e.confirmBatchMove,a.$promise.then(a.show)}},e.confirmFileCopy=function(t,n){angular.isUndefined(t)||angular.isUndefined(n)||n!=e.selectedFolder.id&&o.put(["file",t.code,"copy",n]).then(function(){r.success(translations.DONE)})},e.confirmFileMove=function(t,n){angular.isUndefined(t)||angular.isUndefined(n)||n!=e.selectedFolder.id&&o.put(["file",t.code,"move",n]).then(function(){r.success(translations.DONE),e.loadFiles(!0)})},e.loadFiles=function(t){if(t)e.page=0;else if(e.page<0)return;if(e.busy=!0,e.selectedFolder.id>0)var a={folder_id:e.selectedFolder.id};else var a={space_code:n.spaceCode};a.sort=e.sort.column,a.asc=e.sort.asc,a.filter=e.filter,a.page=e.page,o.get(["file"],a).then(function(t){if(0==e.page)e.files=t;else for(i=0;i<t.length;i++)e.files.push(t[i]);t.length<50&&(e.page=-1),e.toFolders=JSON.parse(JSON.stringify(e.folders)),e.menuIndex>0&&e.toFolders.splice(e.menuIndex,1),e.toFolders.shift(),e.busy=!1},function(){e.busy=!1})},e.$watch("selectedFolder",function(t){angular.isDefined(t)&&(e.menuIndex=t.id,e.loadFiles(!0))}),e.treeOptions={nodeChildren:"childs",dirSelectable:!0,injectClasses:{ul:"a1",li:"a2",liSelected:"a7",iExpanded:"a3",iCollapsed:"a4",iLeaf:"a5",label:"a6",labelSelected:"a8"}},e.loadFolders(!1),e.$parent.selected=1}]),app.controller("spaceStreamCtrl",["$scope","$state","$timeout","apiService","formatterService","$stateParams","spaceFactory","contentService","$q","$http",function(e,t,n,a,o,r,s,l,c,d){e.people=null,e.hm=hm,e.currentSpace=s,l.setSpace(r.spaceCode),e.stream=[],e.formatter=o,e.shareType=0,e.streamFilter=null,e.filter=null,e.filterIndex=0,e.busy=!1,e.limitTags=15,e.filterTag=0,e.$parent.selected=0,e.newPosts=!1,e.lastPostDate=0,e.viewAllTagsClick=function(){e.limitTags=100},e.filterClick=function(t){e.filterIndex=t;e.filter=0==t?null:1==t?{key:"starred",value:!0}:{key:"class_id",value:t-2},e.loadStream(!0)},e.newContent=l.prepareNewContent(),e.$on("contentDeletedEvent",function(t,n){var a=findWithAttr(e.stream,"id",n);a>=0&&(e.currentSpace.loadTags(),e.loadEvents(),e.stream.splice(a,1))}),e.deleteClick=function(t){var n=findWithAttr(e.stream,{id:t});n>=0&&e.loadStream()},e.loadFiles=function(){a.get(["file"],{asc:!1,space_code:r.spaceCode,view:1,sort:"created_at",page:0}).then(function(t){e.latestFiles=t})},e.shareTypeClick=function(t){e.shareType=t,e.newContent=l.prepareNewContent(e.newContent.content_text)},e.getTagText=function(e){return"#"+e.tag},e.paging=function(){e.busy||e.loadStream(!1)},e.searchTag=function(t){var n=e.currentSpace.tags(),n=_(n).reject(function(e){return 0!=e.tag.toLowerCase().indexOf(t.toLowerCase())});return n.sort(function(e,t){return e.tag.toLowerCase()<t.tag.toLowerCase()?-1:e.tag.toLowerCase()>t.tag.toLowerCase()?1:0}),n.length>10&&(n=n.slice(0,10)),e.products=n,c.when(n)},e.confirmQuit=function(){a.get(["quit",r.spaceCode]).then(function(){t.go("home")})},e.peopleClick=function(t){e.$emit("peopleDialogEvent",t)},e.getMemberTooltip=function(e){return e.role<3?e.full_name:e.full_name+"<br>"+translations.MODERATOR},e.getPeopleTextRaw=function(e){return"@"+e.code},e.searchPeople=function(t){if(!isEmpty(t)){var n=[],a={params:{ini:t}};return d.get(apiUrl+"/space/"+e.currentSpace.code()+"/users",a).then(function(t){return t.data.success?(angular.forEach(t.data.data,function(e){n.push(e)}),e.people=n,c.when(n)):void 0})}},e.pool=function(){l.pool(e.lastPostDate).then(function(t){!e.newPosts&&t&&snd.play(),e.newPosts=t>0,u=n(e.pool,6e4)})},e.events=[],e.loadEvents=function(){a.get(["event"],{space_code:r.spaceCode,view:"short"}).then(function(t){e.events=t})},e.inviteClick=function(){e.$parent.inviteUsers()},e.postClick=function(){l.post(e.newContent,e.shareType).then(function(t){t.content_text.indexOf('"hashtag"')>=0&&e.currentSpace.loadTags(),e.stream.splice(0,0,t),e.errors=null,5==e.shareType&&e.loadEvents(),e.shareType=0,e.newContent.files.length>0&&e.loadFiles(),e.newContent=l.prepareNewContent()},function(t){e.errors=t},function(){})},e.filterTagClick=function(t){e.filterTag=e.filterTag==t?0:t,e.loadStream(!0)},e.poolClick=function(){e.filterTag=0,e.filter=null,e.filterIndex=0,e.stream=[],n(function(){e.loadStream(!0)})},e.deleteall=function(){},e.loadStream=function(t){if(t)e.fromDate=moment().utc().add("1","hours").format("YYYY-MM-DD HH:mm:ss"),e.newPosts=0;else if(-1==e.fromDate)return;e.busy=!0;var n={from_date:e.fromDate};e.filter&&(n[e.filter.key]=e.filter.value),e.filterTag>0&&(n.tag=e.filterTag),l.getStream(n).then(function(n){for(t&&(e.stream=[],e.newPosts=!1),i=0;i<n.length;i++)e.lastPostDate<parseInt(moment.utc(n[i].updated_at).format("X"))&&(e.lastPostDate=parseInt(moment.utc(n[i].updated_at).format("X"))),e.stream.push(n[i]);e.fromDate=n.length<10?-1:e.stream[e.stream.length-1].updated_at,e.busy=!1},function(){e.busy=!1})},e.getUrlToFile=function(e){return apiUrl+"/file/"+e},e.loadStream(!0);var u=n(e.pool,6e4);e.loadEvents(),e.loadFiles(),e.$on("$destroy",function(){n.cancel(u)}),e.getAvatar=function(e){return assetsUrl+"/avatar/"+e+".jpg"},e.formatDesc=function(t,n,a){return res="",""!=t&&(res=t+" - "),res=res+e.formatter.formatDate(a)+" ("+e.formatter.formatFileSize(n)+")"},e.$on("commentNewFiles",function(){e.loadFiles()})}]),app.controller("spaceWikiCtrl",["$scope","$state","$stateParams","$previousState","$sce","$upload","apiService","growl","spaceFactory","formatterService",function(e,t,n,a,i,o,r,s,l,c){e.currentSpace=l,e.formatter=c,e.wikis=[],e.menuIndex=-1,e.editing=!1,e.editWiki={},e.newFiles=[],e.fileIndex=0,e.$parent.selected=2,e.searchText="",e.searching=!1,e.searchCancelClick=function(){e.searchText="",e.loadWikis()},e.uploadClick=function(){$("#_fileInput").click()},e.saveClick=function(){e.editing&&(e.editWiki.id>0?r.put(["wiki",e.editWiki.id],{title:e.editWiki.title,access:e.editWiki.access,body:$("#htmleditor").code()}).then(function(t){e.wikis[e.menuIndex]=t,e.wikis[e.menuIndex].body=i.trustAsHtml(t.body),e.editing=!1}):0==e.editWiki.id&&r.post(["wiki"],{title:e.editWiki.title,access:e.editWiki.access,space_code:n.spaceCode,body:$("#htmleditor").code()}).then(function(t){e.wikis.push(t),e.editing=!1,e.menuClick(e.wikis.length-1)}))},e.confirmDeleteClick=function(){r.delete(["wiki",e.wikis[e.menuIndex].id]).then(function(){e.wikis.splice(e.menuIndex,1),e.wikis.length>0&&(e.menuIndex=0)})},e.confirmDeleteFileClick=function(t){r.delete(["file",t]).then(function(){var n=findWithAttr(e.wikis[e.menuIndex].attachments,"code",t);n>=0&&e.wikis[e.menuIndex].attachments.splice(n,1)})},e.newWikiClick=function(){e.editWiki={id:0,title:"",body:"",access:"PU"},$("#htmleditor").code(""),e.editing=!0,e.newFiles=[]},e.delteWikiClick=function(){},e.editWikiClick=function(){e.menuIndex<0||(e.editing=!0,e.editWiki={},e.editWiki=JSON.parse(JSON.stringify(e.wikis[e.menuIndex])),$("#htmleditor").code(e.editWiki.editBody))},e.loadWikis=function(){var t={space_code:n.spaceCode};e.searching=""!==e.searchText,""!==e.searchText&&(t.s=e.searchText),r.get(["wiki"],t).then(function(t){e.wikis=t,t.length>0&&e.menuClick(0)})},e.menuClick=function(t){e.menuIndex=t,e.newFiles=[],e.wikis.length>0&&(e.wikis[t].body||r.get(["wiki",e.wikis[t].id,"body"]).then(function(n){e.wikis[t].body=i.trustAsHtml(n),e.wikis[t].editBody=n}))},e.onFileSelect=function(t){for(var n="",a=0;a<t.length;a++){e.fileIndex++,n=e.fileIndex+"-"+a,e.newFiles.push({original_name:t[a].name,id:n,file_size:t[a].size,status:"w"});var i=t[a];i.id=a,e.upload=o.upload({url:apiUrl+"/file",data:{id:n,filedate:i.lastModifiedDate,wiki_id:e.wikis[e.menuIndex].id},file:i}).success(function(t){var n=_.findWhere(e.newFiles,{id:t.data.id});t.success?("deleted"!=n.status&&(n.status="done"),n.id=t.data.code,e.wikis[e.menuIndex].attachments.push(t.data)):n.status="error"}).error(function(t,n,a,i){var o=_.findWhere(e.newFiles,{id:i.file.id});o.status="error"})}},e.getUrlToFile=function(e){return apiUrl+"/file/"+e},e.loadWikis()}]),app.filter("highlight",["$sce",function(e){"use strict";return function(t,n,a){return a&&t&&(n||angular.isNumber(n))?(t=t.toString(),n=n.toString(),e.trustAsHtml(t.replace(new RegExp(n,"gi"),'<span class="ui-match">$&</span>'))):t}}]),app.controller("tasksCtrl",["$scope","$state","$stateParams","$previousState","apiService",function(e,t,n,a,i){e.tasks=[],e.$parent.selected=3,e.showingArchived=!1,e.spaceCode=n.spaceCode,e.menuIndex=0,e.loadTasks=function(t){var a=angular.isDefined(n.spaceCode)?{space_code:n.spaceCode}:{};angular.isDefined(t)&&(a.archived=1),i.get(["task"],a).then(function(t){e.tasks=t,e.getCounters()})},e.menuClick=function(t){e.menuIndex=t;var n=[{},{my:!0},{delegated:!0}];3>t?(e.showingArchived&&e.loadTasks(),e.showingArchived=!1,e.filter=n[t]):(e.loadTasks(!0),e.showingArchived=!0,e.filter={}),e.$broadcast("taskMenuChanged")},e.newTaskClick=function(){e.$broadcast("newTaskClickEvent")},e.archivedClick=function(){e.loadTasks(!0),e.showingArchived=!0,e.filter={}},e.$on("taskUpdateCounters",function(){e.getCounters()}),e.getCounters=function(){var t=angular.isDefined(n.spaceCode)?{space_code:n.spaceCode}:null;i.get(["task/counters"],t).then(function(t){e.counters=t})},e.loadTasks()}]),app.controller("userprofileCtrl",["$scope","formatterService","apiService","$stateParams","$timeout","$state",function(e,t,n,a,i,o){e.formatter=t,e.icons=["fa fa-comment","fa fa-link","fa fa-table","fa fa-bar-chart","fa fa-check-square","fa fa-calendar","fa fa-map-marker"],e.privateMessage="",e.userid=a.userid,n.get(["profile",e.userid]).then(function(n){e.profile=n,e.avatar=t.getAvatar(e.profile.id);for(var a=0;a<n.custom_fields.length;a++)"date"==n.custom_fields[a].type&&(e.profile["custom_"+n.custom_fields[a].name]=moment(e.profile["custom_"+n.custom_fields[a].name]).format("L"))}),n.get(["profile/activity",e.userid]).then(function(t){e.contents=t}),e.gotoSpace=function(e){i(function(){o.go("space.stream",{spaceCode:e})})},e.zoomClick=function(e){o.go("post",{contentId:e})},e.sendMessageClick=function(){""!=e.privateMessage&&n.post("message",{to_id:e.userid,body:e.privateMessage}).then(function(){e.privateMessage=""})}}]),app.filter("joinBy",function(){return function(e,t){return"[object Array]"===Object.prototype.toString.call(e)?(e||[]).join(t||","):e}}),app.filter("words",function(){return function(e,t){if(isNaN(t))return e;if(0>=t)return"";if(e){var n=e.split(/\s+/);n.length>t&&(e=n.slice(0,t).join(" ")+"…")}return e}}),app.service("apiService",["$http","$q","usSpinnerService","growl",function(e,t,n,a){var i=function(e){return function(t){if(n.stop("appSpinner"),t.message&&(t.alert?a[t.alert](t.message):a.warning(t.message)),t._debug&&console.debug(t._debug._SERVER.REQUEST_METHOD+":"+t._debug._SERVER.REQUEST_URI,t),t.success)e.resolve(t.extra?{data:t.data,extra:t.extra}:t.data);else{var i=angular.isDefined(t.errors)?t.errors:null;e.reject(i)}}},o=function(e){return function(t,i){a.error("Error: "+i),e.notify(i),n.stop("appSpinner")}},r={promise:function(a,r,s,l,c){"mainpool"!=r&&"chat"!==r[0]&&n.spin("appSpinner");var d=t.defer();return head="",l=angular.isDefined(l),r instanceof Array&&(r=r.join("/")),"get"!==a&&"post"!==a&&(head={"X-HTTP-Method-Override":a},a="post"),e({method:a,cache:l,url:apiUrl+"/"+r,params:s,headers:head,data:c}).success(i(d)).error(o(d)),d.promise},get:function(e,t){return this.promise("get",e,t)},getCached:function(e,t){return this.promise("get",e,t,!0)},post:function(e,t){return this.promise("post",e,null,!1,t)},put:function(e,t){return this.promise("put",e,null,!1,t)},"delete":function(e,t){return this.promise("delete",e,t)}};return r}]),app.service("contentService",["$q","apiService",function($q,apiService){var currentSpaceCode=null,contentClasses={0:{name:"message"},1:{name:"link"},2:{name:"table"},3:{name:"chart"},4:{name:"poll",validate:"newContent.poll.options.length > 1"},5:{name:"event"},6:{name:"location"}};return{setSpace:function(e){currentSpaceCode=e},getStream:function(e){return apiService.get(["content/space",currentSpaceCode],e)},pool:function(e){return apiService.get(["pool",currentSpaceCode,e])},getOne:function(e){return apiService.get(["content",e],{truncate:!1})},getTasks:function(e){return apiService.get(["task"],{content_id:e})},prepareNewContent:function(e){var t={};return t.content_text="",isEmpty(e)||(t.content_text=e),t.waiting=!1,t.location={address:"",zoom:14,done:!1,waiting:!1},t.link={title:"",image:"",url:"",description:"",icon:"",done:!1,waiting:!1},t.files=[],t.table={cols:[{type:"text",title:translations.NEW_COLUMN},{type:"text",title:translations.NEW_COLUMN},{type:"text",title:translations.NEW_COLUMN}],rows:[["","",""]]},t.poll={allow_add:!1,options:[""]},t.event={start_date:null,end_date:null,all_day:!1,type:""},t.chart={chartType:"line",labels:[translations.SERIE],xkey:"xlabel",skeys:[1],resize:!0,parseTime:!1,hideHover:"auto",data:[{xlabel:translations.LABEL,s1:0}]},t},"delete":function(e){return apiService.delete(["content",e])},viewMore:function(e){return apiService.get(["viewmore",e])},post:function(newContent,shareType){var deferred=$q.defer(),errors={},payLoad={content_text:newContent.content_text,files:newContent.files};""==newContent.content_text&&(errors.content_text=translations.CONTENT_FIELD_REQUIRED);var className=contentClasses[shareType].name;
return payLoad[className]=newContent[className],angular.isDefined(contentClasses[shareType].validate)&&(eval(contentClasses[shareType].validate)||(errors.validation=!1)),5==shareType&&(moment(newContent.event.start_date).isValid()||(errors["event.start_date"]="Invalid date"),moment(newContent.event.end_date).isValid()||(errors["event.end_date"]="Invalid date"),newContent.event.all_day&&(newContent.event.start_date.setHours(12,0,0),newContent.event.end_date.setHours(12,0,0)),newContent.event.end_date<newContent.event.start_date&&(errors["event.end_date"]="Invalid date"),payLoad.event=newContent.event),jQuery.isEmptyObject(errors)?apiService.post(["content",currentSpaceCode,shareType],payLoad):(deferred.reject(errors),deferred.promise)}}}]),app.service("formatterService",function(){this.formatDateCalendar=function(e){return isEmpty(e)?"":(e=moment.utc(e),e.local(),moment(e).calendar())},this.formatDateCalendarUtc=function(e){return isEmpty(e)?"":(e=moment.utc(e),e.local(),moment(e).calendar())},this.formatDateTime=function(e){return isEmpty(e)?"":(e=moment.utc(e),e.local(),e.format("L h:mm A"))},this.formatDate=function(e){return isEmpty(e)?"":(e=moment.utc(e),e.local(),e.format("MMM D YYYY"))},this.isMe=function(e){return e==user.id},this.longDate=function(e){if(!e)return null;var t=moment(e);return t.isValid()?t.format("LLLL"):null},this.formatMonth=function(e){var t=moment(e);return t.isValid()?t.format("MMM"):null},this.formatDay=function(e){return moment(e).format("D")},this.formatFileSize=function(e){if(""==e||null==e)return"";var e=parseInt(e);return e>1e6?(e/1e6).toFixed(2)+" MB":e>1e3?(e/1e3).toFixed(2)+" KB":e+" Bytes"},this.getMyAvatar=function(){return this.getAvatar(user.id)},this.getAvatar=function(e){return assetsUrl+"/avatar/"+e+".jpg"},this.getFullName=function(){return user.fullname}}),app.factory("spaceFactory",["$q","$http",function(e,t){var n=null;return{setCurrent:function(){t.get(apiUrl+"/space/")},list:function(){var n=e.defer();return 0==spaces.length?t.get(apiUrl+"/space/userspaces").then(function(e){e.data.success&&(spaces=e.data.spaces,n.resolve(e.data.spaces))}):n.resolve(spaces),n.promise},get:function(t){var n=e.defer();return 0==spaces.length?this.list().then(function(){n.resolve(spaces[findWithAttr(spaces,"code",t)])}):n.resolve(spaces[findWithAttr(spaces,"code",t)]),n.promise},setCurrent:function(a){var i=e.defer();return this.get(a).then(function(e){t.get(apiUrl+"/space/"+a+"/users").success(function(t){t.success&&(spaceUsers=t.users,n=spaces[findWithAttr(spaces,"code",a)],i.resolve(e))})}),i.promise},getSpaceUsers:function(){var t=e.defer();return t.resolve(spaceUsers),t.promise}}}]),app.factory("contentFactory",["$http",function(e){return{content:[],addElement:function(e){this.contents.push(e)},showElements:function(){},getChilds:function(t){return e.get(apiUrl+"/content/"+t+"/childs")},getEvents:function(t){return t&&(t={params:t}),e.get(apiUrl+"/content/"+space.id+"/events",t)},getStream:function(t,n){return n&&(n={params:n}),e.get(apiUrl+"/stream/"+t,n)},deleteContent:function(t){return e.delete(apiUrl+"/content/"+t)},saveContent:function(t,n,a){return e.post(apiUrl+"/content/"+t+"/"+n,a)},likeContent:function(t){return e.get(apiUrl+"/content/"+t+"/like")},setFavorite:function(t){return e.get(apiUrl+"/content/"+t+"/favorite")},getFiles:function(t){return t&&(t={params:t}),e.get(apiUrl+"/content/"+space.id+"/files",t)},getLatestFiles:function(){return e.get(apiUrl+"/content/"+space.id+"/latestfiles")},getWikis:function(t){return t.length>0&&(t={params:{tags:t}}),e.get(apiUrl+"/content/"+space.id+"/wikis",t)},getEntry:function(t){return e.get(apiUrl+"/content/entry/"+t)},setWikiOrder:function(t,n){return e.get(apiUrl+"/content/wiki/"+t+"/order/"+n)}}}]),app.factory("spaceFactory",["$q","$http","$cacheFactory","$state","apiService","$cacheFactory",function(e,t,n,a,i,n){var o=null,r=[];return{current:function(){return o},invalidateSpaceCache:function(){o&&n.get("$http").remove(apiUrl+"/space/"+o.code)},spaceList:function(e){return angular.isDefined(e)?void(r=e):r},loadSpaces:function(t){t&&n.get("$http").remove(apiUrl+"/space");var a=e.defer();return i.getCached("space").then(function(e){r=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},loadTags:function(){o&&i.get(["tag",o.code]).then(function(e){o.tags=e})},accessDesc:function(){return o?"PU"==o.access?translations.PUBLIC:translations.PRIVATE:void 0},access:function(){return o?o.access:void 0},title:function(){return o?o.title:void 0},active:function(){return o?o.active:void 0},options:function(){return o?o.options:void 0},tasks:function(){return o?o.options.features.indexOf("tasks")>=0:void 0},featuresDesc:function(){if(o){for(var e=angular.copy(o.options.features),t=0;t<e.length;t++)translations[e[t].toUpperCase()]&&(e[t]=translations[e[t].toUpperCase()]);return e.join(", ")}},members:function(){return o?o.users:void 0},tags:function(){return o?o.tags:void 0},description:function(){return o?o.description:void 0},isDefault:function(){return o?o.default_space:void 0},code:function(){return o?o.code:void 0},role:function(){return o?o.role:void 0},isMine:function(e){return e==user.id},isLoaded:function(){return null!==o},setCurrent:function(t){var n=e.defer();return o=null,i.getCached(["space",t]).then(function(e){o=e,n.resolve(e)},function(){a.go("home")}),n.promise}}}]),app.service("starService",["apiService",function(e){return{toggle:function(t,n){return e.get(["star",t,n])}}}]);